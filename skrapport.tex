%% chscite Sk√•nings rapportklass
%%
%% Copyright (C) 2012-2013 by Simon Sigurdhsson <sigurdhsson@gmail.com>
%% 
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%% 
%% This work has the LPPL maintenance status `maintained'.
%% 
%% The Current Maintainer of this work is Simon Sigurdhsson.
%% 
%% This work consists of the file skrapport.tex and the 
%% derived files skrapport.cls, skrapport-colortheme-default.sty,
%% skrapport-colortheme-unscathed.sty, skrapport-colortheme-violet.sty
%% and skrapport-colortheme-cruelwater.sty.
\documentclass{skdoc}
\let\SI\relax
\usepackage{siunitx}
\DeclareSIUnit\point{pt}
\usepackage{hologo,booktabs}
\usepackage[style=authoryear]{biblatex}
\usepackage{csquotes}
%\usepackage{chslacite}

\ExplSyntaxOn
\cs_set_protected_nopar:Npn\ExplHack{
    \char_set_catcode_letter:n{ 58 }
    \char_set_catcode_letter:n{ 95 }
}
\ExplSyntaxOff

% Hide the implementation
%\OnlyDescription

% Bibliography entries
\begin{filecontents}{skrapport.bib}
    @article{kpfonts,
        author = {Christophe Caignaert},
        title = {KP-Fonts 3.31},
        year = {2010},
        url = {http://www.tex.ac.uk/tex-archive/fonts/kpfonts/doc/kpfonts.pdf}
    }
    @standard{ISO216,
        title = {ISO 216:2007},
        subtitle = {Writing paper and certain classes of printed matter -- Trimmed sizes -- A and B series, and indication of machine direction},
        author = {{International Organization for Standardization, Technical Committee 6}},
        year = {2007}
    }
\end{filecontents}
\addbibresource{skrapport.bib}

% Declare the target files
\SelfPreambleTo{\mypreamble}
\DeclareFile[key=class,preamble=\mypreamble]{skrapport.cls}
\DeclareFile[key=theme-default,preamble=\mypreamble]%
    {skrapport-colortheme-default.sty}
\DeclareFile[key=theme-unscathed,preamble=\mypreamble]%
    {skrapport-colortheme-unscathed.sty}
\DeclareFile[key=theme-cruelwater,preamble=\mypreamble]%
    {skrapport-colortheme-cruelwater.sty}
\DeclareFile[key=theme-violet,preamble=\mypreamble]%
    {skrapport-colortheme-violet.sty}
\DeclareFile[key=theme-skdoc,preamble=\mypreamble]%
    {skrapport-colortheme-skdoc.sty}

% This is where the documentation begins
\begin{document}
    % Change & version info
    \version{0.11a}
    \changes{0.01}{Initial version}
    \changes{0.03}{Removed \cs{rd} and \cs{id}}
    \changes{0.04}{Added \pkg{microtype} package}
    \changes{0.05}{Improved documentation}
    \changes{0.06}{Corrected cheksum, further improved documentation}
    \changes{0.07}{Various bugfixes, \hologo{XeLaTeX} compatibility, 
                    better float settings, quote style fix,
                    \opt{intlimits} option to \pkg{amsmath}}
    \changes{0.07a}{Fixed \pkg{kpfonts} issues}
    \changes{0.09}{Introduced \pkg{kvoptions},
                    fixed abstract in twocolumn mode}
    \changes{0.10}{Include skmath if exists
                    and wanted. Gobble optional arguments to
                    \env{figure} and \env{table} in two-column mode.}
    \changes{0.10a}{Include \pkg{xparse} (fixes breakage).}
    \changes{0.11}{Added \opt{minion} for Adobe Minion Pro font}
    \changes{0.11a}{Added \opt{skdoc} font option and \thm{skdoc} color theme}

    % Metadata
    \package[ctan=skrapport,vcs=https://github.com/urdh/skrapport]{skrapport}
    \title{The \textbf{\thepackage} document class}
    \author{Simon Sigurdhsson}
    \email{sigurdhsson@gmail.com}

    % First page
    \maketitle
    \begin{abstract}
        A document class intended for simple documents \emph{e.g.}
        reports handed in to courses and such. It is small,
        straightforwars and heavily inspired by the Prac\TeX{}
        Journal style.
    \end{abstract}
    \tableofcontents

    \section{Documentation}
    \subsection{Loading the class}
    The document class is loaded using \cs{documentclass} as usual,
    but it has a bunch of options that you might want to know about.

    \subsubsection{Compatibility options}
    There are a couple of options that are mostly provided for
    compatibility with the standard \LaTeXe\ document classes. These
    will do exactly the same thing they do in the standard classes,
    although they may differ in default value. Although some of these
    are key-value options, for compatibility their valid values may
    also be passed as keys.

    \Options{paper}\WithValues{a4paper, a5paper}\AndDefault{a4paper}
    Specifying paper size is possible using the \opt{paper} option
    (the values of which are based
    on European paper sizes; use the \pkg{geometry} package for other
    standards). Only A4 and A5 are defined since these two sizes cover
    pretty much all intended use of the class. \opt{a4paper} is the
    default value of this option, and the only other valid value is
    \opt{a5paper}.

    \Options{ptsize}\WithValues{10pt, 11pt, 12pt}\AndDefault{11pt}
    The same font sizes specified in the standard classes are also
    available in \thepackage\ (\emph{i.e.} \opt{10pt},
    \opt{11pt} and \opt{12pt}. The default font size is
    \opt{11pt}, and there should be no compelling reason to change
    this.

    \Options{draft,final}
    The \opt{draft} and \opt{final} options work as expected, triggering
    or untriggering the familiar draft mode. The default is \opt{final}.

    \Options{fleqn,leqno}
    Purely for compatibility \thepackage\ also defines the \opt{fleqn}
    and \opt{leqno} options. As with the standard \LaTeXe\ classes,
    \opt{fleqn} aligns equations with the left-hand margin and
    \opt{leqno} places equation numbers to the left. None of these
    are activated by default.

    \subsubsection{Typographic options}
    There is also a number of options available to change certain
    aspects of the typography of the typeset document.

    \Options{titles}\WithValues{rm, bf, sf}\AndDefault{rm}
    There are three different ways to typeset section headings in
    \thepackage: \texttt{rm} (upright serif), \texttt{bf} (boldfaced
    serif) and \texttt{sf} (sans serif). The default is \texttt{rm}.

    \Options{font}\WithValues{nofont, lmodern, palatino, kpfonts, minion, skdoc}\AndDefault{kpfonts}
    In addition, the specific font can also be changed --- the available
    choices are \texttt{lmodern} (Latin Modern), \texttt{kpfonts}
    (Kp-Fonts), \texttt{minion} (Adobe Minion Pro), \texttt{palatino} (either \TeX-Gyre Pagella or
    Pazo Math depending on what's available) and \texttt{skdoc} (PT Serif and Open Sans, the style used by \pkg{skdoc}), with the default being
    \texttt{kpfonts}. It is also possible to tell \thepackage\ not
    to use any font (\texttt{nofont}), which is sometimes useful
    when using \hologo{XeLaTeX}, among other things.

    \Options{indent,noindent}
    Controlling indentation is posible using the options
    \texttt{(no)indent}. The default, \texttt{noindent}, behaves
    much like the \pkg{parskip} package in that it replaces
    paragraph indentation with vertical spacing.

    \Options{onecolumn,twocolumn}
    Similar to the options available in the standard classes, these
    options specify wether to typeset the document in one or two
    columns. Unlike the standard classes, the two-column mode is
    implemented using \pkg{multicol}. The default is \opt{onecolumn}.

    \subsubsection{Other options}
    \Options{swe,eng}
    Either \pkg{babel} or \pkg{polyglossia} (depending on engine) is
    loaded by the package. These options specify what language should
    be used as the main language (swedish or english); both languages
    are always loaded. The default is \opt{swe}.

    \Options{color,nocolor}
    It is also possible to load \pkg{xcolor} inside the package. If
    this is done, a range of color themes (discussed later) will be
    available in the package and these will affect the document. The
    default value is \opt{color}.

    \Options{math,nomath}
    Loading the \pkg{skmath} package is recommended and as such it is
    loaded by default. If this for some reason is undesirable, the
    \opt{nomath} option will supress this behaviour.

    \subsection{Macros and environments}
    In general, the class defines the same macros as the \pkg{article} class, and adds a few. Only the novel ones are described here, as
    the inherited ones should behave identically.

    \subsubsection{Front-matter and metadata}
    \DescribeMacro\license{<license>}
    The \cs{license} macro specifies the name of a license under which
    the document is available. This will be typeset on the lower right
    corner of the title page. \Notice{The license will only be printed
    if the \env{titlepage} environment is used.}

    \DescribeMacro\regarding{<text>}
    The class adds a \cs{regarding} macro, which is used like the 
    standard \cs{author} and \cs{title} macros and should be given an 
    accurate but short description of the purpose of the report (i.e.
    ~course name or similar). This is printed along with the date on 
    the top of the title/first page.

    \DescribeMacro\author[<email>]{<author>}
    The \cs{author} macro is redefined in two ways. To begin with, the
    macro now acceps an optional argument specifying the email address
    of the author. If the macro is used multiple times, authors are
    appended to the list of author names displayed by \cs{maketitle}.

    \DescribeMacro\maketitle
    The title page (or rather, block) has been refashioned to mimic the
    Prac\TeX\ Journal style. This means a fairly compact block, starting
    with a line of text containing the date and subject matter, followed
    by a large skip and then the title, author and optionally an
    abstract set ragged-right and fairly close together.

    \subsubsection{Useful macros}
    The class defines a few additional macros that aren't available in
    \pkg{article} but don't fit in any specifiv \enquote{set} of
    features. These include commands to typeset comments.

    \DescribeMacro\comment*{<comment>}
    \DescribeMacro\com*{<comment>}
    \DescribeMacro\note*{<comment>}
    The \cs{comment} macro (also available in an unstarred variant)
    typesets a comment. The starred variant typesets the commen in red
    prefixed by the word \enquote{Comment}, while the unstarred variant
    typesets the comment as a margin note (but still prefixed). The
    \cs{com} and \cs{note} macros are aliases of \cs{comment}.

    \subsubsection{Two-column mode}
    \DescribeEnv[<content>]{onecol}
    In \opt{twocolumn} mode, the package defines an environment
    \env{onecol} which typesets its contents in a single column. 
    Additionally, it redefines \env{figure} and \env{table} as
    non-floats, leaving the starred versions intact.

    \subsubsection{Color themes}
    \DescribeMacro\colortheme{<theme>}
    If the package is loaded with the \opt{color} option, changing the color theme is
    possible using \cs{colortheme}, which loads an
    appropriate package. At the moment, four color themes are available.

    \Theme{default}
    The \thm{default} theme is fairly conservative, only coloring
    \pkg{hyperef} links with more readable, slightly darker colors than
    the standard ones. It should print well even on non-color printers.

    \Theme{unscathed}
    The \thm{unscathed} theme is based on a palette with the same
    name on COLOURlovers%
\footnote{\url{http://www.colourlovers.com/palette/1440498/unscathed}},
    and applies a \textcolor[HTML]{463335}{dark brown} color to
    emphasized text, a \textcolor[HTML]{CF5D3B}{rusty} color to links,
    a \textcolor[HTML]{B34430}{darker rust} color to titles and a
    \textcolor[HTML]{70524A}{lighter brown} to quotes.

    \Theme{cruelwater}
    The \thm{cruelwater} theme is also based on a palette from 
    COLOURlovers%
\footnote{\url{http://www.colourlovers.com/palette/126030/Cruel_Water_at_Night}},
    and applies a \textcolor[HTML]{030C22}{dark blue} color to bold
    text and captions, a \textcolor[HTML]{20293F}{slightly less dark 
    blue} to titles and emphasized text, a \textcolor[HTML]{A9B0B3}{
    light gray} color to small print and a \textcolor[HTML]{404749}{
    darker gray} to quotes.

    \Theme{violet}
    The \thm{violet} theme, like \thm{unscathed} and \thm{cruelwater},
    is based on a COLOURlovers palette%
\footnote{\url{http://www.colourlovers.com/palette/1831303/Violet_White_Bedrm}}.
    It colors all links \textcolor[HTML]{932444}{bright purple}, applies
    a \textcolor[HTML]{311A2A}{dark puple} color to titles, bold text
    and captions, a \textcolor[HTML]{D6CBCF}{grayish purple} to small
    print, a \textcolor[HTML]{463335}{dark brown} color to quotes and a
    \textcolor[HTML]{98758D}{pastel violet} color to emphasized text.

    \Theme{skdoc}
    The \thm{skdoc} theme is loosely based on the \pkg{skdoc} document class, with which this documentation is typeset.

    \subsection{Additional information}
    The document class includes a number of packages by default. This
    is useful to know, since passing explicit options to these packages
    will require you to utilize the \cs{PassOptionsToPackage} macro
    before you load the class using \cs{documentclass}.
    Table~\ref{tab:pkgs} lists the packages included by \thepkg\ along
    with their options (if applicable).

    \begin{table}[tbp]
        \centering
        \caption{User-level packages included by \thepkg.}
        \label{tab:pkgs}
        \begin{tabular}{llp{15em}}
            \toprule
            \textbf{Package} & \textbf{Options} & \textbf{Comments} \\
            \midrule
            \pkg{amsmath} & \texttt{intlimits} & Provides \hologo{AmS} commands and environments. \\
            \pkg{amssymb} & & Only if not using \opt{kpfonts}.\\
            \pkg{babel} & see options \opt{swe} and \opt{eng} & Only loaded if \emph{not} using \hologo{XeTeX}.\\
            \pkg{calc} & & \\
            \pkg{fontenc} & \texttt{T1} & Only loaded if \emph{not} using \hologo{XeTeX}. Makes sure we are using a good font encoding for crisp appearance on-screen (OT1 is horrible). \\
            \pkg{fontspec} & \texttt{quiet} & Only loaded if using \hologo{XeTeX}. Provides basic OTF font selection commands.\\
            \pkg{geometry} & \texttt{a4paper} or \texttt{a5paper} & This is used by the \opt{paper} option to set the paper area. \\
            \pkg{icomma} & & \\
            \pkg{inconsolata} & & \\
            \pkg{microtype} & & Provides micro-typographic improvements.\\
            \pkg{multicol} & & Only loaded with the \opt{twocolumn} option.¬†\\
            \pkg{polyglossia} & see options \opt{swe} and \opt{eng} & Only loaded if using \hologo{XeTeX}.\\
            \pkg{skmath} & & Only if it exists and \opt{nomath} isn't set.\\
            \pkg{textcomp} & & Only if not using \opt{kpfonts}.\\
            \pkg{xcolor} & & Only loaded with the \opt{color} option.\\
            \bottomrule
        \end{tabular}
    \end{table}

    \section{Known issues}
    A list of current issues is available in the Github repository of this
    package\footnote{\url{https://github.com/urdh/skrapport/issues}}, but as
    of the release of \theversion, there are no known issues:
    %\begin{description}
    %    \item[\#6]  ???
    %\end{description}
    
    If you discover any bugs in this package, please report them to the issue
    tracker in the \thepackage\ Github repository.

    \Implementation\ExplHack
    \section{Implementation}
    Start by including \pkg{expl3}, \pkg{l3keys2e} and some other
    useful packages, as well as declaring the class.
\begin{MacroCode}{class}
\RequirePackage{expl3,l3keys2e,xparse,xstring,etoolbox}
\ProvidesExplClass{skrapport}%
    {2013/04/10}{0.11a}{stylish report document class}
\end{MacroCode}
    
    \subsection{Messages}
    Tons of messages are declared for future use.
\begin{MacroCode}{class}
\msg_new:nnnn{skrapport}{option-deprecated}{Option~`#1'~deprecated!}
    {Please~use~`#2'~instead.}
\msg_new:nnnn{skrapport}{option-no-effect}{Option~`#1'~deprecated!}
    {It~has~no~effect;~simply~use~nothing~instead.}
\msg_new:nnnn{skrapport}{invalid-paper-size}{Invalid~paper~size~`#1'!}
    {\token_to_str:N\__skrapport_setup_paper:n~was~invoked~with~an~
     invalid~argument;~paper~size~will~remain~unchanged.}
\msg_new:nnnn{skrapport}{invalid-point-size}{Invalid~point~size~`#1'!}
    {\token_to_str:N\__skrapport_setup_ptsize:n~was~invoked~with~an~
     invalid~argument;~cannot~continue~without~setting~a~valid~point~
     size.~Please~fix~the~issue~before~typesetting~again.}
\msg_new:nnnn{skrapport}{invalid-titles}{Invalid~title~type~`#1'!}
    {\token_to_str:N\__skrapport_setup_titles:n~was~invoked~with~an~
     invalid~argument;~falling~back~to~`#2'.}
\msg_new:nnnn{skrapport}{invalid-lang}{Invalid~language~`#1'!}
    {\token_to_str:N\__skrapport_setup_lang:n~was~invoked~with~an~
     invalid~argument;~`babel'~and/or~`polyglossia'~will~remain~
    unloaded.}
\msg_new:nnnn{skrapport}{invalid-font}{Invalid~font~`#1'!}
    {\token_to_str:N\__skrapport_setup_font:n~was~invoked~with~an~
     invalid~argument;~no~font~package~has~been~loaded.~This~may~result~
     in~bad~rendering~due~to~old~Computer~Modern~fonts.}
\msg_new:nnnn{skrapport}{noop-call}{No-op~invokation~of~macro!}
    {\token_to_str:N#1~was~invoked,~but~circumstances~dictate~that~the~
    macro~should~do~nothing.~Will~do~\token_to_str:N\prg_do_nothing:~
    instead.}
\end{MacroCode}
    This message should probably not be used at all. Except in
    development versions straight off Github, of course.
\begin{MacroCode}{class}
\msg_new:nnn{skrapport}{not-implemented}
    {Unimplemented~macro~\token_to_str:N#1!}
\end{MacroCode}

    \subsection{Options}
    First, a few booleans used by parts of the option handling code.
    \begin{macro}{\g__skrapport_draft_bool}
    Are we in \opt{draft} mode?
\begin{MacroCode}{class}
\bool_new:N\g__skrapport_draft_bool
\end{MacroCode}
    \end{macro}
    \begin{macro}{\g__skrapport_color_bool}
    Are we supposed to be using \opt{color}s?
\begin{MacroCode}{class}
\bool_new:N\g__skrapport_color_bool
\end{MacroCode}
    \end{macro}
    \begin{macro}{\g__skrapport_has_polyglossia_bool}
    Has \pkg{polyglossia} been loaded?
\begin{MacroCode}{class}
\bool_new:N\g__skrapport_has_polyglossia_bool
\end{MacroCode}
    \end{macro}

    Let's define some \pkg{l3keys} corresponding to the options. Note
    that most of them just refer to a macro in their \texttt{.code:n}
    block --- these macros are defined after the \cs{keys_define:nn}
    block.
\begin{MacroCode}{class}
\keys_define:nn{skrapport}{
\end{MacroCode}
    \begin{option}{paper}{a4paper, a5paper, a4, a5}
    \changes{0.12}{Values \texttt{a4paper} and \texttt{a5paper} are
                  now deprecated}
    \begin{option}{a4paper}
    \changes{0.12}{Option is now deprecated}
    \begin{option}{a5paper}
    \changes{0.12}{Option is now deprecated}
    Declare the paper size options. Note that having to handle the
    deprecated \texttt{a4paper} and \texttt{a5paper} values of the
    \opt{paper} option makes the code less readable. In a few
    versions, when these options are removed, the code should probably
    be refactored to look something like the \opt{ptsize} option below.
\begin{MacroCode}{class}
    paper .choice:,
    paper / a4 .code:n =
        {\__skrapport_setup_paper:n{a4}},
    paper / a5 .code:n =
        {\__skrapport_setup_paper:n{a5}},
    paper / a4paper .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {paper=a4paper}{paper=a4}
         \keys_set:nn{skrapport}{paper=a4}},
    paper / a5paper .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {paper=a5paper}{paper=a5}
         \keys_set:nn{skrapport}{paper=a4}},
    paper .value_required:,
    paper .initial:n = a4,
    a4paper .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {a4paper}{paper=a4}
         \keys_set:nn{skrapport}{paper=a4}},
    a5paper .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {a5paper}{paper=a5}
         \keys_set:nn{skrapport}{paper=a5}},
\end{MacroCode}
    \end{option}
    \end{option}
    \end{option}

    \begin{option}{ptsize}{10pt, 11pt, 12pt}
    \begin{option}{10pt}
    \begin{option}{11pt}
    \begin{option}{12pt}
    Declare point size options. Note that we don't deprecate the
    non-\opt{ptsize} aliases as they are much easier to type.
\begin{MacroCode}{class}
    ptsize .choices:nn =
        { 10pt, 11pt, 12pt }
        {\__skrapport_setup_ptsize:x{\tl_use:N\l_keys_choice_tl}},
    ptsize .value_required:,
    ptsize .initial:n = 11pt,
    10pt .meta:n = {ptsize=10pt},
    11pt .meta:n = {ptsize=11pt},
    12pt .meta:n = {ptsize=12pt},
\end{MacroCode}
    \end{option}
    \end{option}
    \end{option}
    \end{option}

    \begin{option}{twocolumn}
    \changes{0.08}{Added option \opt{twocolumn}}
    Declare column options. The code here should be run through
    \cs{AtEndClass} so that the setup code can patch everythin
    properly.
    \begin{option}{onecolumn}
    \changes{0.12}{Option is now deprecated}
    The \opt{onecolumn} option has no effect and is deprecated.
\begin{MacroCode}{class}
    twocolumn .code:n =
        {\AtEndClass{\__skrapport_setup_twocolumn:}},
    onecolumn .code:n =
        {\msg_warning:nnn{skrapport}{option-no-effect}{onecolumn}},
\end{MacroCode}
    \end{option}
    \end{option}

    \begin{option}{draft}{true, false}
    \begin{option}{final}
    Declare \opt{draft} and \opt{final} options. Note that even if the
    \opt{final} option does absolutely nothing, users may expect it to
    be there and as such it is not deprecated.
\begin{MacroCode}{class}
    draft .choice:,
    draft / true .code:n =
        {\bool_gset_true:N\g__skrapport_draft_bool
         \__skrapport_setup_draft:},
    draft / false .code:n = 
        {\bool_gset_false:N\g__skrapport_draft_bool},
    draft .default:n = true,
    draft .initial:n = false,
    final .code:n = {\prg_do_nothing:},
\end{MacroCode}
    \end{option}
    \end{option}

    Declare the \opt{fleqn} and \opt{leqno} options, mainly for
    compatibility with the \pkg{article} class.
    \begin{option}{leqno}
\begin{MacroCode}{class}
    leqno .code:n =
        {\__skrapport_setup_leqno:},
\end{MacroCode}
    \end{option}
    \begin{option}{fleqn}
\begin{MacroCode}{class}
    fleqn .code:n =
        {\__skrapport_setup_fleqn:},
\end{MacroCode}
    \end{option}

    \begin{option}{titles}{rm, bf, sf}
    Declare options for section titles. The old \opt*{??titles} aliases
    are deprecated and will be removed in a future version.
    \begin{option}{rmtitles}
    \changes{0.12}{Option is now deprecated}
    \begin{option}{bftitles}
    \changes{0.12}{Option is now deprecated}
    \begin{option}{sftitles}
    \changes{0.09}{Added \opt{sftitles} option}
    \changes{0.12}{Option is now deprecated}
\begin{MacroCode}{class}
    titles .choices:nn =
        { rm, bf, sf }
        {\__skrapport_setup_titles:x{\tl_use:N\l_keys_choice_tl}},
    titles .value_required,
    titles .initial:n = bf,
    rmtitles .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {rmtitles}{titles=rm}
         \keys_set:nn{skrapport}{titles=rm}},
    bftitles .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {bftitles}{titles=bf}
         \keys_set:nn{skrapport}{titles=bf}},
    sftitles .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {sftitles}{titles=sf}
         \keys_set:nn{skrapport}{titles=sf}},
\end{MacroCode}
    \end{option}
    \end{option}
    \end{option}
    \end{option}

    \begin{option}{lang}{sv, en}
    \changes{0.12}{Incompatible change: values \texttt{swe} and
                   \texttt{eng} are now \texttt{sv} and \texttt{en},
                   respectively}
    \begin{option}{swe}
    \changes{0.12}{Option is now deprecated}
    \begin{option}{eng}
    \changes{0.12}{Option is now deprecated}
    Declare options for swedish/english \pkg{babel} or
    \pkg{polyglossia} support. Again, the old \opt{swe} and \opt{eng}
    aliases are deprecated and will be removed.
\begin{MacroCode}{class}
    lang .choices:nn = 
        { sv, en }
        {\__skrapport_setup_lang:x{\tl_use:N\l_keys_choice_tl}},
    lang .value_required:,
    lang .initial:n = sv,
    swe .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {swe}{lang=sv}
         \keys_set:nn{skrapport}{lang=sv}},
    eng .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {eng}{lang=en}
         \keys_set:nn{skrapport}{lang=en}},
\end{MacroCode}
    \end{option}
    \end{option}
    \end{option}

    \begin{option}{font}{none, kpfonts, lmodern, palatino, minion, skdoc}
    Declare font options. Again, aliases are deprecated.
    \begin{option}{kpfonts}
    \changes{0.07}{Added option \opt{kpfonts}, set as default
                    option for fonts}
    \changes{0.12}{Option is now deprecated}
    \begin{option}{lmodern}
    \changes{0.12}{Option is now deprecated}
    \begin{option}{palatino}
    \changes{0.12}{Option is now deprecated}
    \begin{option}{minion}
    \changes{0.11}{Added option \opt{minion}}
    \changes{0.12}{Option is now deprecated}
    \begin{option}{skdoc}
    \changes{0.11a}{Added option \opt{skdoc}}
    \changes{0.12}{Option is now deprecated}
    \begin{option}{nofont}
    \changes{0.12}{Option is now deprecated}
\begin{MacroCode}{class}
    font .choices:nn =
        { none, kpfonts, lmodern, palatino, minion, skdoc }
        {\__skrapport_setup_font:x{\tl_use:N\l_keys_choice_tl}},
    font .value_required:,
    font .initial:n = kpfonts,
    nofont .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {nofont}{font=none}
         \keys_set:nn{skrapport}{font=none}},
    kpfonts .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {kpfonts}{font=kpfonts}
         \keys_set:nn{skrapport}{font=kpfonts}},
    lmodern .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {lmodern}{font=lmodern}
         \keys_set:nn{skrapport}{font=lmodern}},
    palatino .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {palatino}{font=palatino}
         \keys_set:nn{skrapport}{font=palatino}},
    minion .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {minion}{font=minion}
         \keys_set:nn{skrapport}{font=minion}},
    skdoc .code:n = 
        {\msg_warning:nnnn{skrapport}{option-deprecated}
            {skdoc}{font=skdoc}
         \keys_set:nn{skrapport}{font=skdoc}},
\end{MacroCode}
    \end{option}
    \end{option}
    \end{option}
    \end{option}
    \end{option}
    \end{option}
    \end{option}

    \begin{option}{indent}{true, false}
    \changes{0.02}{Added option of indented paragraphs}
    \begin{option}{noindent}
    \changes{0.12}{Option is now deprecated}
    Declare indentation options. Since the \opt{noindent} option
    technically has no effect and is an alias of \opt{indent=false},
    it has been deprecated.
\begin{MacroCode}{class}
    indent .choice:,
    indent / true .code:n = {\prg_do_nothing:},
    indent / false .code:n = {\__skrapport_setup_parskip:},
    indent .default:n = true,
    indent .initial:n = false,
    noindent .code:n =
        {\msg_warning:nnn{skrapport}{option-no-effect}{noindent}},
\end{MacroCode}
    \end{option}
    \end{option}

    \begin{option}{color}{true, false}
    \changes{0.09}{Added \opt{color} option}
    \begin{option}{nocolor}
    Declare color options. Note that we explicitly set the boolean
    \cs{g__skrapport_color_bool} as well as setting up the colors
    through \cs{__skrapport_setup_color:}, so that we can keep track
    of the color usage even after the options have been set up.
\begin{MacroCode}{class}
    color .choice:,
    color / true .code:n =
        {\bool_gset_true:N\g__skrapport_color_bool
         \__skrapport_setup_color:},
    color / false .code:n = 
        {\bool_gset_false:N\g__skrapport_color_bool},
    color .default:n = true,
    color .initial:n = true,
    nocolor .meta:n = {color=false},
\end{MacroCode}
    \end{option}
    \end{option}

    \begin{option}{nomath}{true, false}
    \begin{option}{math}
    \changes{0.12}{Option is now deprecated}
    Declare math options. As with the \opt{noindent} option, \opt{math}
    has been deprecated since it is an alias and has no effect.
\begin{MacroCode}{class}
    nomath .choice:,
    nomath / false = .code:n {\__skrapport_setup_math:},
    nomath / true = .code:n {\prg_do_nothing:},
    nomath .default:n = true,
    nomath .initial:n = false,
    math .code:n =
        {\msg_warning:nnn{skrapport}{option-no-effect}{math}},
\end{MacroCode}
    \end{option}
    \end{option}
    
    That's it, we're done setting up the \pkg{l3keys} for the options.
    Next up is the actual setup code for all the options.
\begin{MacroCode}{class}
}
\end{MacroCode}

    \subsection{Option setup macros}
    In this section, all options declared in the previous section are
    implemented using setup macros. Some of these may have to be called
    in an appropriate order, but I haven't checked that yet.

    \begin{macro}{\__skrapport_setup_paper:n}[1]
        {Paper size (\texttt{a4} or \texttt{a5})}
    The paper size is set by loading \pkg{geometry} \emph{and} explicitly
    setting the \cs{paperheight} and \cs{paperwidth} dimensions. Perhaps
    this can be improved.
\begin{MacroCode}{class}
\cs_new:Npn\__skrapport_setup_paper:n#1{
    \str_case:nnn{#1}{
\end{MacroCode}
    An A4 paper as defined by ISO216\footcite{ISO216} is
    \SI{210x297}{\milli\metre}.
\begin{MacroCode}{class}
        {a4}{
            \RequirePackage[a4paper]{geometry}
            \dim_gset:Nn\paperheight {297mm}
            \dim_gset:Nn\paperwidth  {210mm}
        }
\end{MacroCode}
    An A5 paper as defined by ISO216\footcite{ISO216} is
    \SI{148x210}{\milli\metre}.
\begin{MacroCode}{class}
        {a5}{
            \RequirePackage[a5paper]{geometry}
            \dim_gset:Nn\paperheight {210mm}
            \dim_gset:Nn\paperwidth  {148mm}
        }
    }{
\end{MacroCode}
    Invalid paper sizes (such calls should never happen) are
    handled by issuing a warning and hoping that the default
    paper size is acceptable.
\begin{MacroCode}{class}
        \msg_warning:nnn{skrapport}{invalid-paper-size}{#1}
    }
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_ptsize:n}[1]
        {Point size (\texttt{10pt}, \texttt{11pt} or \texttt{12pt})}
    The standard point sizes are defined much like in the \pkg{article}
    class, \emph{i.e.} by saving a number and loading \file{size10.clo},
    \file{size11.clo} or \file{size12.clo} as appropriate
\begin{MacroCode}{class}
\cs_new:Npn\__skrapport_setup_ptsize:n#1{
    \str_case:nnn{#1}{
\end{MacroCode}
    \begin{macro*}{\c__skrapport_ptsize_token}
\begin{MacroCode}{class}
        {10pt}{\token_new:Nn\c__skrapport_ptsize_token{0}}
        {11pt}{\token_new:Nn\c__skrapport_ptsize_token{1}}
        {12pt}{\token_new:Nn\c__skrapport_ptsize_token{2}}
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
    }{
\end{MacroCode}
    Invalid point sizes are critical errors, since we can't recover
    from them in any reasonable way. Loading a default point size is
    unreasonable, since all in-class calls to this macro should know
    what sizes are available, and if you're calling it with invalid
    parameters from elsewhere, you should be punished.
\begin{MacroCode}{class}
        \msg_critical:nnn{skrapport}{invalid-point-size}{#1}
    }
    \file_input:n{size1\c__skrapport_ptsize_token .clo}
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_twocolumn:}
    Setting up for twocolumn mode isn't implemented yet. Note that this
    macro should be called from \cs{AtEndClass} to ensure that we patch
    everything correctly.
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_setup_twocolumn:{
    \RequirePackage{etoolbox}
    \RequirePackage{multicol}
    \msg_fatal:nnn{skrapport}{not-implemented}
        {\__skrapport_setup_twocolumn:}
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_leqno:}
    Instead of loading \file{leqno.clo}, we reimplement the (tiny) file
    as LaTeX3 code and include it directly. It's not terribly advanced.
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_setup_leqno:{
    \RenewDocumentCommand\@eqnnum{}{
        \hbox_to_wd:nn{.01pt}{}
        \hbox_overlap_right:n{
            \normalfont\normalcolor
            \skip_horizontal:n{-\displaywidth}
            (\theequation)
        }
    }
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_fleqn:}
    The \file{fleqn.clo} functionality is more complex, so we include
    the file instead of reimplementing.
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_setup_fleqn:{
    \file_input:n{fleqn.clo}
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_titles:n}[1]
        {Title style (\texttt{rm}, \texttt{bf} or \texttt{sf})}
    The title styles are implemented by creating a new macro
    \cs{__skrapport_title_style:} which will later be used by
    \cs{section} and friends. 
\begin{MacroCode}{class}
\cs_new:Npn\__skrapport_setup_titles:n#1{
    \str_case:nnn{#1}{
\end{MacroCode}
    \begin{macro*}{\__skrapport_title_style:}
        \changes{0.11a}{Removed incorrect \cs{bfseries}, replaced
                        \cs{relax} with \cs{rmfamily}}
\begin{MacroCode}{class}
        {rm}{\cs_new:Nn\__skrapport_title_style:{\rmfamily}}
        {bf}{\cs_new:Nn\__skrapport_title_style:{\bfseries}}
        {sf}{\cs_new:Nn\__skrapport_title_style:{\sffamily}}
\end{MacroCode}
    \end{macro*}
    The fall-back for incorrect parameters is an informational message
    along with setting up for \cs{rmfamily} titles.
\begin{MacroCode}{class}
    }{
        \msg_info:nnnn{skrapport}{invalid-titles}{#1}{rm}
        \__skrapport_setup_titles:n{rm}
    }
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_lang:n}[1]
        {Language (\texttt{sv} or \texttt{en})}
    Thus far only two language options are implemented, each of them
    setting the other as the \enquote{other} language. We check if
    \pkg{polyglossia} has been loaded (this is done by
    \cs{__skrapport_setup_xelatex:}): if it has, we use the
    \pkg{polyglossia} interface for setting languages, otherwise we 
    load the \pkg{babel} package with appropriate options.
\begin{MacroCode}{class}
\cs_new:Npn\__skrapport_setup_lang:n#1{
    \str_case:nnn{#1}{
        {sv}{
            \bool_if:NTF\g__skrapport_has_polyglossia_bool{
                \setmainlanguage{swedish}
                \setotherlanguage[variant=british]{english}
            }{
                \RequirePackage[british,swedish]{babel}
            }
        }
        {en}{
            \bool_if:NTF\g__skrapport_has_polyglossia_bool{
                \setmainlanguage[variant=british]{english}
                \setotherlanguage{swedish}
            }{
                \RequirePackage[swedish,british]{babel}
            }
        }
    }{
\end{MacroCode}
    Fallback prints an informational message and leaves both \pkg{babel}
    and \pkg{polyglossia} unloaded.
\begin{MacroCode}{class}
        \msg_info:nnn{skrapport}{invalid-lang}{#1}
    }
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_font:n}[1]
        {Font (\texttt{none}, \texttt{kpfonts}, \texttt{lmodern},
         \texttt{palatino}, \texttt{minion} or \texttt{skdoc})}
    We set up the somewhat involved font stack.
\begin{MacroCode}{class}
\cs_new:Npn\__skrapport_setup_font:n#1{
\end{MacroCode}
    To begin with, we load \pkg{inconsolata} as our monospace font,
    letting it be overridden later if another font stack provides
    a monospace font. But we don't load it when using the \texttt{none}
    font stack.
\begin{MacroCode}{class}
    \str_if_eq:nnF{#1}{none}{
        \RequirePackage[scaled=1.03]{inconsolata}
    }
    \str_case:nnn{#1}{
\end{MacroCode}
    The \texttt{none} font stack does literally nothing.
\begin{MacroCode}{class}
        {none}{\prg_do_nothing:}
\end{MacroCode}
    The \texttt{kpfonts} font stack simply loads \pkg{kpfonts}...
\begin{MacroCode}{class}
        {kpfonts}{
            \RequirePackage[easyscsl,intlimits,sumlimits]{kpfonts}
        }
\end{MacroCode}
    ...and the \texttt{lmodern} font stack loads \pkg{lmodern}.
\begin{MacroCode}{class}
        {lmodern}{
            \RequirePackage{lmodern}
        }
\end{MacroCode}
    The \texttt{palatino} font stack loads \pkg{tgpagella} if available,
    but falls back to \pkg{mathpazo} otherwise.
\begin{MacroCode}{class}
        {palatino}{
            \file_if_exist:nTF{tgpagella.sty}{
                \RequirePackage{tgpagella}
            }{
                \RequirePackage[osf]{mathpazo}
            }
        }
\end{MacroCode}
    Minion Pro, provided by the \texttt{minion} font stack, loads both
    \pkg{minionpro} (the font) and \pkg{MnSymbol} (appropriate math
    symbols).
\begin{MacroCode}{class}
        {minion}{
            \RequirePackage{minionpro}
            \RequirePackage{MnSymbol}
        }
\end{MacroCode}
    Finally, the \texttt{skdoc} font stack loads \pkg{PTSerif} and
    \pkg{opensans}, inspired by the style of the \pkg{skdoc} class.
\begin{MacroCode}{class}
        {skdoc}{
            \RequirePackage{PTSerif}
            \RequirePackage[defaultsans,osfigures,scale=0.95]{opensans}
        }
    }{
\end{MacroCode}
    As a fallback, we print a waning and load no font packages.
\begin{MacroCode}{class}
        \msg_warning:nnn{skrapport}{invalid-font}{#1}
    }
\end{MacroCode}
    All font stacks except \texttt{none} and \texttt{kpfonts} require
    additional packages. Or, rather, \texttt{none} can't load these
    packages by definition, and \texttt{kpfonts} already loads them
    internally \footcite[p.~1]{kpfonts}. They are always useful.
\begin{MacroCode}{class}
    \str_if_eq:nnF{#1}{kpfonts}{
        \str_if_eq:nnF{#1}{none}{
            \BeforeEndPreamble{
                \let\Finv\relax
                \let\Game\relax
                \let\beth\relax
                \let\gimel\relax
                \let\daleth\relax
                \RequirePackage[intlimits]{amsmath}
                \RequirePackage{amssymb}
                \RequirePackage{textcomp}
            }
        }
    }
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_parskip:}
    This part mixes \LaTeXe\ and \LaTeX3, which may not be a good thing.
    On the other hand, it seems hard to avoid. Most of the code is
    half-lifted from \pkg{parskip} and converted to \LaTeX3.
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_setup_parskip:{
    \skip_gset:Nn\parskip{0.5\baselineskip plus 2pt}
    \dim_gzero:N\parindent
    \skip_gset:Nn\parfillskip{30pt plus 1fil}
\end{MacroCode}
    \begin{macro*}{\@listI}
    \begin{macro*}{\@listi}
\begin{MacroCode}{class}
    \cs_gset:Npn\@listI{
        \dim_gset_eq:NN\leftmargin\leftmargini
        \dim_gset_eq:NN\parsep\parskip
        \dim_gzero:N\topsep
        \dim_gzero:N\itemsep
    }
    \cs_gset_eq:NN\@listi\@listI
\end{MacroCode}
    \end{macro*}
    \end{macro*}
\begin{MacroCode}{class}
    \@listi
\end{MacroCode}
    \begin{macro*}{\@listii}
\begin{MacroCode}{class}
    \cs_gset:Npn\@listii{
        \dim_gset_eq:NN\leftmargin\leftmarginii
        \dim_gset_eq:NN\labelwidth\leftmarginii
        \dim_gset_eq:NN\parsep\parskip
        \dim_gsub:Nn\labelwidth{-\labelsep}
        \dim_gzero:N\topsep
        \dim_gzero:N\itemsep
    }
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\@listiii}
\begin{MacroCode}{class}
    \cs_gset:Npn\@listiii{
        \dim_gset_eq:NN\leftmargin\leftmarginiii
        \dim_gset_eq:NN\labelwidth\leftmarginiii
        \dim_gset_eq:NN\parsep\parskip
        \dim_gsub:Nn\labelwidth{-\labelsep}
        \dim_gzero:N\topsep
        \dim_gzero:N\itemsep
    }
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
    \dim_gzero:N\partopsep
\end{MacroCode}
    \begin{macro*}{\@starttoc}
\begin{MacroCode}{class}
    \RenewDocumentCommand\@starttoc{m}{
        \group_begin:
        \dim_gzero:N\parskip
        \file_if_exist:nT{\c_job_name_tl.#1}{
            \file_input:n{\c_job_name_tl.#1}
        }
        \if@filesw
            \iow_new:c{tf@#1}
            \iow_open:cn{tf@#1}{\c_job_name_tl.#1}
        \fi
        \@nobreakfalse
        \group_end:
    }
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_math:}
    This is the simplest option, only loading \pkg{skmath} if it exists.
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_setup_math:{
    \file_if_exist:nT{skmath.sty}{\RequirePackage{skmath}}
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_draft:}
    Setting up the \opt{draft} mode is also fairly easy, as we only need
    wider (wider than \SI{0}{\point}, that is) \cs{overfullrule}s.
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_setup_draft:{
    \bool_if:NTF\g__skrapport_draft_bool{
        \dim_gset:Nn\overfullrule{5pt}
    }{
        \msg_log:nnn{skrapport}{noop-call}{\__skrapport_setup_draft:}
        \prg_do_nothing:
    }
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_color:}
    Setting up colors is also fairly easy, as we only have to load the
    \pkg{xcolor} package. All the other color-related code is in other
    places, utilizing the \cs{g__skdoc_color_bool} boolean.
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_setup_color:{
    \bool_if:NTF\g__skrapport_color_bool{
        \RequirePackage{xcolor}
    }{
        \msg_log:nnn{skrapport}{noop-call}{\__skrapport_setup_color:}
        \prg_do_nothing:
    }
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_xelatex:}
    This macro contains special setup code for the \hologo{XeTeX} and
    \hologo{LuaTeX} engines, such as loading \pkg{fontspec}, providing
    missing commands (which have been replaced by equivalent Unicode
    characters, apparently) and loading \pkg{polyglossia}.
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_setup_xelatex:{
    \RequirePackage[quiet]{fontspec}
\end{MacroCode}
    \begin{macro}{\nobreakspace}
\begin{MacroCode}{class}
    \DeclareDocumentCommand\nobreakspace{}{\leavevmode\nobreak\space}
\end{MacroCode}
    \end{macro}
\begin{MacroCode}{class}
    \RequirePackage{polyglossia}
    \bool_gset_true:N\g__skrapport_has_polyglossia_bool
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_pdftex:}
    This macro contains special setup code for the \hologo{pdfTeX}
    engine. Currently, it only sets the font encoding to T1.
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_setup_pdftex:{
    \RequirePackage[T1]{fontenc}
    \bool_gset_false:N\g__skrapport_has_polyglossia_bool
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\__skrapport_setup_engine_specific:}
    This macro detects the current engine and calls the appropriate
    engine setup macro.
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_setup_engine_specific:{
    \bool_if:nTF{\luatex_if_engine_p: || \xetex_if_engine_p:}{
        \__skrapport_setup_xelatex:
    }{
        \__skrapport_setup_pdftex:
    }
}
\end{MacroCode}
    \end{macro}

    \subsubsection{Variants with expandable arguments}
    Some option setup macros accept arguments, but those arguments are
    not expanded. Here, we provide variants which expand the parameters
    properly using the excellent \pkg{l3prg} functionality.
    \begin{macro}{\__skrapport_setup_ptsize:x}
\begin{MacroCode}{class}
\cs_generate_variant:Nn\__skrapport_setup_ptsize:n{ x }
\end{MacroCode}
    \end{macro}
    \begin{macro}{\__skrapport_setup_titles:x}
\begin{MacroCode}{class}
\cs_generate_variant:Nn\__skrapport_setup_titles:n{ x }
\end{MacroCode}
    \end{macro}
    \begin{macro}{\__skrapport_setup_lang:x}
\begin{MacroCode}{class}
\cs_generate_variant:Nn\__skrapport_setup_lang:n{ x }
\end{MacroCode}
    \end{macro}
    \begin{macro}{\__skrapport_setup_font:x}
\begin{MacroCode}{class}
\cs_generate_variant:Nn\__skrapport_setup_font:n{ x }
\end{MacroCode}
    \end{macro}

    Finally, we process the class options using the keys defined earlier.
    We also run the engine-specific code implemented above.
\begin{MacroCode}{class}
\__skrapport_setup_engine_specific:
\ProcessKeysOptions{skrapport}
\end{MacroCode}

    \subsection{Loading packages}
    \subsubsection{Required packages}
    We also include some essential packages per default. The
    \pkg{calc} package, for instance, is essential in later
    definitions.
\begin{MacroCode}{class}
\RequirePackage{calc}
\end{MacroCode}

    At the end of the class definition we load a couple of very
    useful packages that improve typesetting. These are
    \pkg{microtype}, \pkg{icomma}.
\begin{MacroCode}{class}
\AtEndOfClass{
    \RequirePackage{microtype}
    \RequirePackage{icomma}
}
\end{MacroCode}
    
    When the document starts, we set the URL style if the user has
    loaded the \pkg{url} package.
\begin{MacroCode}{class}
\AtBeginDocument{
    \cs_if_exist:NT\urlstyle{\urlstyle{same}}
}
\end{MacroCode}

    \subsection{Utilities}
    We define useful \LaTeX3 replacements of \LaTeXe\ stuff that
    hasn't made its way into \pkg{interface3}. This includes counter
    mechanisms (compatible with \LaTeXe\ code), a \cs{settowidth}
    clone and possibly more stuff later.
    \begin{macro*}{\dim_set_to_wd:Nn}
\begin{MacroCode}{class}
\cs_new:Npn\dim_set_to_wd:Nn#1#2{
    \hbox_set:Nn\l_tmpa_box{#2}
    \dim_set:Nn#1{\box_wd:N\l_tmpa_box}
    \box_clear:N\l_tmpa_box
}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\ctr_new:n}[1]
        {Counter name}
\begin{MacroCode}{class}
\cs_new:Npn\ctr_new:n#1{
    \@definecounter{#1} % !!!
    \@ifnextchar[{\@newctr{#1}}{} % !!!
}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\ctr_gzero:n}[1]
        {Counter name}
\begin{MacroCode}{class}
\cs_new:Npn\ctr_gzero:n#1{
    \int_gzero:c{c@#1}
}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\ctr_gset:nn}[2]
        {Counter name}
        {New value}
\begin{MacroCode}{class}
\cs_new:Npn\ctr_gset:nn#1#2{
    \int_gset:cn{c@#1}{#2}
}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\ctr_gincr:n}[1]
        {Counter name}
\begin{MacroCode}{class}
\cs_new:Npn\ctr_gincr:n#1{
    \int_gincr:cn{c@#1}
}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\ctr_ref_gincr:n}[1]
        {Counter name}
\begin{MacroCode}{class}
\cs_new:Npn\ctr_ref_gincr:n#1{
    \ctr_gincr:n{#1}
    \cs_gset_protected:Nn\@currentlabel{
        \cs:w p@#1\cs_end:
        \cs:w the#1\cs_end:
    }
}
\end{MacroCode}
    \end{macro*}
    
    \subsection{Hidden things}
    Set some default measurements (should probably be replaced with
    simply loading \pkg{scrpage2}).
\begin{MacroCode}{class}
\dim_add:Nn\textwidth{0.5\oddsidemargin}
\dim_add:Nn\textwidth{0.5\evensidemargin}
\dim_add:Nn\oddsidemargin{-0.5\oddsidemargin}
\dim_add:Nn\evensidemargin{-0.5\evensidemargin}
\dim_gset:Nn\lineskip{1pt}
\dim_gset:Nn\normallineskip{1pt}
\end{MacroCode}
    \begin{macro}{\baselinestretch}
\begin{MacroCode}{class}
\RenewDocumentCommand\baselinestretch{}{}
\end{MacroCode}
    \end{macro}

    \subsubsection{Penalties}
\begin{MacroCode}{class}
\int_gset:Nn\@lowpenalty  {51}
\int_gset:Nn\@medpenalty {151}
\int_gset:Nn\@highpenalty{301}
\ctr_gset:nn{topnumber}{2}
\ctr_gset:nn{bottomnumber}{1}
\ctr_gset:nn{totalnumber}{4}
\ctr_gset:nn{dbltopnumber}{2}
\end{MacroCode}
    \begin{macro*}{\topfraction}
    \begin{macro*}{\bottomfraction}
    \begin{macro*}{\textfraction}
    \begin{macro*}{\floatpagefraction}
    \begin{macro*}{\dbltopfraction}
    \begin{macro*}{\dblfloatpagefraction}
\begin{MacroCode}{class}
\RenewDocumentCommand\topfraction{}{.75}
\RenewDocumentCommand\bottomfraction{}{.5}
\RenewDocumentCommand\textfraction{}{.25}
\RenewDocumentCommand\floatpagefraction{}{.625}
\RenewDocumentCommand\dbltopfraction{}{.75}
\RenewDocumentCommand\dblfloatpagefraction{}{.625}
\end{MacroCode}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \end{macro*}

    \subsection{User-level commands}
    \subsubsection{The front page}
    \begin{macro}{\author}[2]
        {Optional email address}
        {Author name}
    \changes{0.10b}{Improved \cs{author} macro}
    The \cs{author} macro is redefined to accept an optional argument
    and to be used multiple times. This will be rewritten to store
    both author and email in a suitable data structure (probably some
    kind of token list) instead of simply dumb-appending to a local
    macro.
    \begin{macro*}{\__skrapport_email:n}[1]
        {Email address}
    The \cs{skrapport@email} helper macro typesets an email address
    using \pkg{hyperref} if that package is used. This is suboptimal,
    the macro behaves differently with respect to special characters
    depending on wether \pkg{hyperref} is loaded or not.
\begin{MacroCode}{class}
\cs_new_nopar:Npn\__skrapport_email:n#1{
    \texttt{#1}
}
\AtBeginDocument{
    \cs_if_exist:NT\href{
        \cs_gset_nopar:Npn\__skrapport_email:n#1{
            \href{mailto:#1}{\nolinkurl{#1}}
        }
    }
}
\end{MacroCode}{class}
    \end{macro*}
    \begin{macro*}{\g__skrapport_author_tl}
\begin{MacroCode}{class}
\tl_new:N\g__skrapport_author_tl
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
\DeclareDocumentCommand\author{om}{%
    \tl_set:Nx\l_tmpa_tl{
        #2 \IfNoValueF{#1}{
            ~\(\langle\)\__skrapport_email:n{#1}\(\rangle\)
        }
    }
    \tl_if_empty:NF\g__skrapport_author_tl{
        \tl_gput_right:Nn\g__skrapport_author_tl{\\[0.5ex]}
    }
    \tl_gconcat:NNN\g__skrapport_author_tl
                   \g__skrapport_author_tl\l_tmpa_tl
}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\regarding}[1]
        {Text snippet}
    This macro defines a variable used by \cs{maketitle} to insert a 
    simple text into the header on the title page.
    \begin{macro*}{\g__skrapport_regarding_tl}
\begin{MacroCode}{class}
\tl_new:N\g__skrapport_regarding_tl
\DeclareDocumentCommand\regarding{m}{
    \tl_gset:Nn\g__skrapport_regarding_tl{#1}
}
\end{MacroCode}
    \end{macro*}
    \end{macro}

    \begin{macro}{\license}[1]
        {Short license description}
    \changes{0.07}{Added command \cs{license}}
    This macro defines a variable used by \cs{maketitle} to insert a 
    license into the footer on the titlepage.
    \begin{macro*}{\g__skrapport_copyright_tl}
\begin{MacroCode}{class}
\tl_new:N\g__skrapport_copyright_tl
\DeclareDocumentCommand\license{m}{
    \tl_gset:Nn\g__skrapport_copyright_tl{#1}
}
\end{MacroCode}
    \end{macro*}
    \end{macro}

    \begin{macro}{\maketitle}
    The standard \cs{maketitle} command as taken from the \pkg{article}
    class but with some basic restyling.
    \begin{macro*}{\__skrapport_smallprint_style:}
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_smallprint_style:{}
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
\DeclareDocumentCommand\maketitle{}{
    \par
    \group_begin:
        \RenewDocumentCommand\thefootnote{}{
            \@fnsymbol\c@footnote
        }
        \RenewDocumentCommand\@makefnmark{}{
            \hbox_overlap_right:n{
                \@textsuperscript{\normalfont\@thefnmark}
            }
        }
        \RenewDocumentCommand\@makefntext{m+}{
            \parindent 1em\noindent
            \hbox_to_wd:nn{1.8em}{
                \hss\@textsuperscript{\normalfont\@thefnmark}
            }
            ##1
        }
        \newpage
        \int_gzero:N\@topnum
        \__skrapport_maketitle:
        \thispagestyle{plain}
        \__skrapport_thanks:
    \group_end:
    \ctr_gzero:n{footnote}
}
\end{MacroCode}
    \end{macro}
    \begin{macro*}{\__skrapport_maketitle:}
\begin{MacroCode}{class}
\cs_new:Nn\__skrapport_maketitle:{
    \newpage
    \hbox:n{}
    \begin{flushleft}
        \vspace{-\headsep}
        {
            \small\__skrapport_smallprint_style:
            \tl_use:N\g__skrapport_regarding_tl
            \@date\par
        }
        \vspace{1.5cm}
        {
            \Huge\__skrapport_title_style:
            \@title
            \par
        }
        \vspace{.125cm}
        {
            \Large\__skrapport_title_style:
            \tl_use:N\g__skrapport_regarding_tl
        }
        \vspace{.75cm}
    \end{flushleft}
    \par
}
\end{MacroCode}
    \end{macro*}

    \begin{environment}{abstract}
    Standard restyled \env{abstract} environment from the
    \pkg{article} class.
\begin{MacroCode}{class}
\dim_const:Nn\c__skrapport_abstract_separator_dim{1em}
\DeclareDocumentEnvironment{abstract}{}{
    \dim_set_to_wd:\l_tmpa_dim{\bfseries\abstractname}
    \dim_set:Nn\l_tmbp_dim
        {\textwidth-\l_tmpa_dim-\c__skrapport_abstract_separator_dim}
    \begin{minipage}[t]{\l_tmpa_dim}
        \begin{flushright}
            \leavevmode\bfseries\abstractname
        \end{flushright}
    \end{minipage}
    \hspace{\c__skrapport_abstract_separator_dim}
    \begin{minipage}[t]{\l_tmpb_dim}
}{
    \end{minipage}
}
\end{MacroCode}
    \end{environment}

    \begin{environment}{titlepage}
    Titlepage environment.
    \begin{macro*}{\ps@skrapport@titlepage:}
\begin{MacroCode}{class}
\cs_new:Nn\ps@skrapport@titlepage:{
    \cs_gset:Nn\@oddhead{}
    \cs_gset:Nn\@evenhead{}
    \cs_gset:Nn\@oddfoot{
        \begin{minipage}{\textwidth}
            \raggedleft\small\par
            \__skrapport_smallprint_style:
            \tl_use:N\g__skrapport_copyright_tl
        \end{minipage}
    }
    \cs_gset_eq:Nn\@evenfoot\@oddfoot
}
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
\DeclareDocumentEnvironment{titlepage}{}{
    \cleardoublepage\ctr_gset:nn{page}{1}
}{
    \thispagestyle{skrapport@titlepage}
    \cleardoublepage\ctr_gset:nn{page}{1}
}
\end{MacroCode}
    \end{environment}

    \subsubsection{Sectioning}
    Sectioning commands.
\begin{MacroCode}{class}
\ctr_gset:nn{c@secnumdepth}{3}
\ctr_new:n{section}
\ctr_new:n{subsection}[section]
\ctr_new:n{subsubsection}[subsection]
\ctr_new:n{paragraph}[subsubsection]
\ctr_new:n{subparagraph}[paragraph]
\end{MacroCode}
    \begin{macro*}{\thesection}
    \begin{macro*}{\thesubsection}
    \begin{macro*}{\thesubsubsection}
    \begin{macro*}{\theparagraph}
    \begin{macro*}{\thesubparagraph}
\begin{MacroCode}{class}
\RenewDocumentCommand\thesection{}{
    \@arabic\c@section
}
\RenewDocumentCommand\thesubsection{}{
    \thesection.\@arabic\c@subsection
}
\RenewDocumentCommand\thesubsubsection{}{
    \thesubsection.\@arabic\c@subsubsection
}
\RenewDocumentCommand\theparagraph{}{
    \thesubsubsection.\@arabic\c@paragraph
}
\RenewDocumentCommand\thesubparagraph{}{
    \theparagraph.\@arabic\c@subparagraph
}
\end{MacroCode}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \begin{macro*}{\__skrapport_pre_section:n}[1]
        {Skip before the section title}
\begin{MacroCode}{class}
\cs_new:Npn\__skrapport_pre_section:n#1{
    \leavevmode\par
    \skip_set:Nn\l_tmpa_skip{#1}
    \@afterindenttrue % !!!
    \dim_compare:nT{\l_tmpa_skip<0}{
        \skip_set\l_tmpa_skip{-\l_tmpa_skip}
        \@afterindentfalse % !!!
    }
    \if@nobreak \everypar{} \else
        \addpenalty\@secpenalty % !!!
        \skip_vertical:N\l_tmpa_skip
    \fi
}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\__skrapport_post_section:n}[1]
        {Space after the section title}
\begin{MacroCode}{class}
\cs_new:Npn\__skrapport_post_section:n#1{
    \@xsect{#1} % !!!
}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\__skrapport_section_star:nnn}[3]
    \begin{macro*}{\__skrapport_section_star:nnnn}[4]
        {Indentation of section title}
        {Styling of the section title}
        {Actual section title}
        {Optional code to run in the indentation}
\begin{MacroCode}{class}
\cs_new:Npn\__skrapport_section_star:nnnn#1#2#3{
    \__skrapport_section_star:nnnn{#1}{#2}{#3}{}
}
\cs_new:Npn\__skrapport_section_star:nnnn#1#2#3#4{
    \group_begin:
        #2
        \hbox_set:Nn\l_tmpa_box{{\skip_horizontal:n{#1}#4}}
        \hangindent{#1}\box_wd:N\l_tmpa_box
        \noindent\box_use_clear:N\l_tmpa_box
        \interlinepenalty\@M % !!!
        #3\par
    \group_end:
}
\end{MacroCode}
    \end{macro*}
    \end{macro*}
    \begin{macro*}{\__skrapport_section_nostar:nnnnnn}[6]
        {Section counter name}
        {Section level}
        {Indentation of section title}
        {Styling of the section title}
        {Actual section title}
        {Section title for TOC}
\begin{MacroCode}{class}
\cs_new:Npn\__skrapport_section_nostar:nnnnnn#1#2#3#4#5#6{
    \if_int_compare:w #2>\c@secnumdepth % !!!
        \cs_set:Nn\__skrapport_saved_section:{}
    \else:
        \ctr_ref_ginrc:n{#1}
        \cs_set_protected:Nn\__skrapport_saved_section:{
            \cs:w #1\cs_end:
        }
    \fi:
    \__skrapport_section_star:nnn
        {#3}{#4}{#5}{\__skrapport_saved_section:}
    \cs:w #1mark\cs_end:{#6}
    \addcontentsline{toc}{#1}{
        \if_int_compare:w #2>\c@secnumdepth \else: % !!!
            \protect\numberline{\csname the#1\endcsname} % !!!
        \fi:
        #6
    }
}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\__skrapport_pre_section:x}
\begin{MacroCode}{class}
\cs_generate_variant:Nn\__skrapport_pre_section:n{x}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\__skrapport_post_section:x}
\begin{MacroCode}{class}
\cs_generate_variant:Nn\__skrapport_post_section:n{x}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\__skrapport_section_star:xxn}
\begin{MacroCode}{class}
\cs_generate_variant:Nn\__skrapport_section_star:nnn{xxn}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\__skrapport_section_nostar:nnxxnn}
\begin{MacroCode}{class}
\cs_generate_variant:Nn\__skrapport_section_nostar:nnnnnn{nnxxnn}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\__skrapport_generic_section:nnnnn}[5]
        {Section counter name}
        {Section level}
        {Star (tested with \cs{IfBooleanTF})}
        {Optional argument (or \cs{NoValue})}
        {Section title text}
\begin{MacroCode}{class}
\cs_set:Nn\__skrapport_generic_section:nnnnn{
    \__skrapport_pre_section:x{\cs:w c__skrapport_#1_pre_skip\cs_end:}
    \IfBooleanTF#3{
        \__skrapport_section_star:xxn
            {\cs:w c__skrapport_#1_indent_dim\cs_end:}
            {\cs:w __skrapport_#1_style:\cs_end:}
            {#5}
    }{
        \IfNoValueTF{#4}{
            \__skrapport_section_star:nnxxnn
                {#1}{#2}
                {\cs:w c__skrapport_#1_indent_dim\cs_end:}
                {\cs:w __skrapport_#1_style:\cs_end:}
                {#5}
                {#5}
        }{
            \__skrapport_section_star:nnxxnn
                {#1}{#2}
                {\cs:w c__skrapport_#1_indent_dim\cs_end:}
                {\cs:w __skrapport_#1_style:\cs_end:}
                {#5}
                {#4}
        }
    }
    \__skrapport_post_section:x{\cs:w c__skrapport_#1_post_skip\cs_end:}
}
\end{MacroCode}
    \end{macro*}
    \begin{macro}{\section}
    \begin{macro*}{\c__skrapport_section_pre_skip}
\begin{MacroCode}{class}
\skip_const:Nn\c__skrapport_section_pre_skip{-4ex plus 1ex minus -1ex}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_section_post_skip}
\begin{MacroCode}{class}
\skip_const:Nn\c__skrapport_section_post_skip{.5ex plus .5ex}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_section_indent_dim}
\begin{MacroCode}{class}
\dim_const:Nn \c__skrapport_section_indent_dim{\c_zero_dim}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_section_style:}
\begin{MacroCode}{class}
\cs_set:Nn\__skrapport_section_style:
    {\normalfont\LARGE\__skrapport_title_style:}
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
\DeclareDocumentCommand\section{som}{
    \__skrapport_generic_section:nnnnn{section}{1}{#1}{#2}{#3}
}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\subsection}
    \begin{macro*}{\c__skrapport_subsection_pre_skip}
\begin{MacroCode}{class}
\skip_const:Nn\c__skrapport_subsection_pre_skip{-3ex plus 1ex minus -1ex}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_subsection_post_skip}
\begin{MacroCode}{class}
\skip_const:Nn\c__skrapport_subsection_post_skip{.25ex plus .25ex}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_subsection_indent_dim}
\begin{MacroCode}{class}
\dim_const:Nn \c__skrapport_subsection_indent_dim{\c_zero_dim}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_subsection_style:}
\begin{MacroCode}{class}
\cs_set:Nn\__skrapport_subsection_style:
    {\normalfont\Large\__skrapport_title_style:}
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
\DeclareDocumentCommand\subsection{som}{
    \__skrapport_generic_section:nnnnn{subsection}{2}{#1}{#2}{#3}
}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\subsubsection}
    \begin{macro*}{\c__skrapport_subsubsection_pre_skip}
\begin{MacroCode}{class}
\skip_const:Nn\c__skrapport_subsubsection_pre_skip{-2ex plus .5ex minus -.5ex}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_subsubsection_post_skip}
\begin{MacroCode}{class}
\skip_const:Nn\c__skrapport_subsubsection_post_skip{.125ex plus .125ex}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_subsubsection_indent_dim}
\begin{MacroCode}{class}
\dim_const:Nn \c__skrapport_subsubsection_indent_dim{\c_zero_dim}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_subsubsection_style:}
\begin{MacroCode}{class}
\cs_set:Nn\__skrapport_subsubsection_style:
    {\normalfont\large\__skrapport_title_style:}
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
\DeclareDocumentCommand\subsubsection{som}{
    \__skrapport_generic_section:nnnnn{subsubsection}{3}{#1}{#2}{#3}
}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\paragraph}
    \begin{macro*}{\c__skrapport_paragraph_pre_skip}
\begin{MacroCode}{class}
\skip_const:Nn\c__skrapport_paragraph_pre_skip{1ex plus .25ex minus -.25ex}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_paragraph_post_skip}
\begin{MacroCode}{class}
\skip_const:Nn\c__skrapport_paragraph_post_skip{-1em}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_paragraph_indent_dim}
\begin{MacroCode}{class}
\dim_const:Nn \c__skrapport_paragraph_indent_dim{\c_zero_dim}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_paragraph_style:}
\begin{MacroCode}{class}
\cs_set:Nn\__skrapport_paragraph_style:
    {\normalfont\normalsize\bfseries}
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
\DeclareDocumentCommand\paragraph{som}{
    \__skrapport_generic_section:nnnnn{paragraph}{4}{#1}{#2}{#3}
}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\subparagraph}
    \begin{macro*}{\c__skrapport_subparagraph_pre_skip}
\begin{MacroCode}{class}
\skip_const:Nn\c__skrapport_subparagraph_pre_skip{1ex plus .25ex minus -.25ex}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_subparagraph_post_skip}
\begin{MacroCode}{class}
\skip_const:Nn\c__skrapport_subparagraph_post_skip{-1em}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_subparagraph_indent_dim}
\begin{MacroCode}{class}
\dim_const:Nn \c__skrapport_subparagraph_indent_dim{\parindent}
\end{MacroCode}
    \end{macro*}
    \begin{macro*}{\c__skrapport_subparagraph_style:}
\begin{MacroCode}{class}
\cs_set:Nn\__skrapport_subparagraph_style:
    {\normalfont\normalsize\itshape}
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
\DeclareDocumentCommand\subparagraph{som}{
    \__skrapport_generic_section:nnnnn{subparagraph}{5}{#1}{#2}{#3}
}
\end{MacroCode}
    \end{macro}

    \subsubsection{Commands from \pkg{article}}
    Itemization commands.
\begin{MacroCode}{class}
\setlength\leftmargini{2em}
\leftmargin\leftmargini
\setlength\leftmarginii{2em}
\setlength\leftmarginiii{1.5em}
\setlength\leftmarginiv{1.5em}
\setlength\leftmarginv{1em}
\setlength\leftmarginvi{1em}
\setlength\labelsep{.5em}
\setlength\labelwidth{\leftmargini}
\addtolength\labelwidth{-\labelsep}
\@beginparpenalty -\@lowpenalty
\@endparpenalty   -\@lowpenalty
\@itempenalty     -\@lowpenalty
\end{MacroCode}
    \begin{macro*}{\theenumi}
    \begin{macro*}{\theenumii}
    \begin{macro*}{\theenumiii}
    \begin{macro*}{\theenumiv}
\begin{MacroCode}{class}
\renewcommand\theenumi{\@arabic\c@enumi}
\renewcommand\theenumii{\@alph\c@enumii}
\renewcommand\theenumiii{\@roman\c@enumiii}
\renewcommand\theenumiv{\@Alph\c@enumiv}
\end{MacroCode}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \begin{macro*}{\labelenumi}
    \begin{macro*}{\labelenumii}
    \begin{macro*}{\labelenumiii}
    \begin{macro*}{\labelenumiv}
\begin{MacroCode}{class}
\newcommand\labelenumi{\theenumi.}
\newcommand\labelenumii{\theenumii)}
\newcommand\labelenumiii{\theenumiii.}
\newcommand\labelenumiv{\theenumiv.}
\end{MacroCode}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \begin{macro*}{\p@enumii}
    \begin{macro*}{\p@enumiii}
    \begin{macro*}{\p@enumiiv}
\begin{MacroCode}{class}
\renewcommand\p@enumii{\theenumi}
\renewcommand\p@enumiii{\theenumi(\theenumii)}
\renewcommand\p@enumiv{\p@enumiii\theenumiii}
\end{MacroCode}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \begin{macro*}{\labelitemi}
    \begin{macro*}{\labelitemii}
    \begin{macro*}{\labelitemiii}
    \begin{macro*}{\labelitemiv}
\begin{MacroCode}{class}
\newcommand\labelitemi{\textbullet}
\newcommand\labelitemii{\textopenbullet}
\newcommand\labelitemiii{\normalfont\bfseries\textendash}
\newcommand\labelitemiv{\textrightarrow}
\end{MacroCode}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \begin{environment}{description}
\begin{MacroCode}{class}
\newenvironment{description}
  {\list{}{\labelwidth\z@\itemindent-\leftmargin
    \let\makelabel\descriptionlabel}}{\endlist}
\newcommand*\descriptionlabel[1]{\hspace\labelsep\normalfont\bfseries #1}
\end{MacroCode}
    \end{environment}

    Quotation environments.
    \begin{environment}{quote}
\begin{MacroCode}{class}
\newenvironment{quote}{\list{}{\rightmargin\leftmargin}\item\relax\itshape}{\endlist}
\end{MacroCode}
    \end{environment}
    \begin{environment}{quotation}
\begin{MacroCode}{class}
\newenvironment{quotation}{\bigskip\begin{quote}}{\end{quote}\bigskip}
\end{MacroCode}
    \end{environment}
    \begin{environment}{verse}
\begin{MacroCode}{class}
\newenvironment{verse}{\begin{quote}}{\end{quote}}
\end{MacroCode}
    \end{environment}

    \begin{macro}{\appendix}
    Appendix macro.
\begin{MacroCode}{class}
\newcommand\appendix{\par\setcounter{section}{0}\setcounter{subsection}{0}\gdef\thesection{\@Alph\c@section}}
\end{MacroCode}
    \end{macro}

    Old font commands.
    \begin{macro}{\rm}
\begin{MacroCode}{class}
\DeclareOldFontCommand{\rm}{\normalfont\rmfamily}{\mathrm}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\sf}
\begin{MacroCode}{class}
\DeclareOldFontCommand{\sf}{\normalfont\sffamily}{\mathsf}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\tt}
\begin{MacroCode}{class}
\DeclareOldFontCommand{\tt}{\normalfont\ttfamily}{\mathtt}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\bf}
\begin{MacroCode}{class}
\DeclareOldFontCommand{\bf}{\normalfont\bfseries}{\mathbf}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\it}
\begin{MacroCode}{class}
\DeclareOldFontCommand{\it}{\normalfont\itshape}{\mathit}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\sl}
\begin{MacroCode}{class}
\DeclareOldFontCommand{\sl}{\normalfont\slshape}{\@nomath\sl}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\sc}
\begin{MacroCode}{class}
\DeclareOldFontCommand{\sc}{\normalfont\scshape}{\@nomath\sc}
\end{MacroCode}
    \end{macro}

    \begin{macro}{\emph}
    Redefining the \cs{emph} style to be bold when nested.
    \begin{macro*}{\em}
\begin{MacroCode}{class}
\let\@emstyle\relax
\DeclareRobustCommand\em{%
    \@nomath\em%
    \ifdim \fontdimen\@ne\font >\z@%
        \itshape\bfseries%
    \else%
        \itshape%
    \fi%
    \@emstyle%
}
\end{MacroCode}
    \end{macro*}
    \end{macro}

    \begin{macro*}{\footnoterule}
    Footnote code.
    \begin{macro*}{\@makefntext}
\begin{MacroCode}{class}
\renewcommand\footnoterule{%
    \kern-3\p@
    \hrule\@width.4\columnwidth
    \kern2.6\p@}
\newcommand\@makefntext[1]{%
    \parindent 1em%
    \noindent
    \hb@xt@1.8em{\hss\@makefnmark}#1}
\end{MacroCode}
    \end{macro*}
    \end{macro*}

    Basic translatable texts.
    \begin{macro}{\contentsname}
\begin{MacroCode}{class}
\newcommand\contentsname{Inneh√•ll}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\refname}
\begin{MacroCode}{class}
\newcommand\refname{Referenser}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\figurename}
\begin{MacroCode}{class}
\newcommand\figurename{Figur}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\tablename}
\begin{MacroCode}{class}
\newcommand\tablename{Tabell}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\appendixname}
\begin{MacroCode}{class}
\newcommand\appendixname{Bilaga}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\abstractname}
\begin{MacroCode}{class}
\newcommand\abstractname{Sammanfattning}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\today}
\begin{MacroCode}{class}
\def\today{\year--\month--\day}
\end{MacroCode}
    \end{macro}

    \subsubsection{Floats}
    Figure and table floats.
\begin{MacroCode}{class}
\setlength\arraycolsep{5\p@}
\setlength\tabcolsep{6\p@}
\setlength\arrayrulewidth{.4\p@}
\setlength\doublerulesep{2\p@}
\setlength\tabbingsep{\labelsep}
\skip\@mpfootins=\skip\footins
\setlength\fboxsep{3\p@}
\setlength\fboxrule{.4\p@}
\end{MacroCode}
    \begin{macro*}{\theequation}
\begin{MacroCode}{class}
\renewcommand\theequation{\@arabic\c@equation}
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
\newcounter{figure}\renewcommand\thefigure{\@arabic\c@figure}
\def\fps@figure{tb}
\def\ftype@figure{1}
\def\ext@figure{lof}
\def\fnum@figure{\figurename~\thefigure}
\end{MacroCode}
    \begin{environment}{figure}
    \begin{environment*}{figure*}
\begin{MacroCode}{class}
\newenvironment{figure}{\@float{figure}}{\end@float}
\newenvironment{figure*}{\@dblfloat{figure}}{\end@dblfloat}
\end{MacroCode}
    \end{environment*}
    \end{environment}
\begin{MacroCode}{class}
\newcounter{table}\renewcommand\thetable{\@arabic\c@table}
\def\fps@table{tb}
\def\ftype@table{2}
\def\ext@table{lot}
\def\fnum@table{\tablename~\thetable}
\end{MacroCode}
    \begin{environment}{table}
    \begin{environment*}{table*}
\begin{MacroCode}{class}
\newenvironment{table}{\@float{table}}{\end@float}
\newenvironment{table*}{\@dblfloat{table}}{\end@dblfloat}
\end{MacroCode}
    \end{environment*}
    \end{environment}

    Captions.
\begin{MacroCode}{class}
\let\@captionstyle\relax
\newlength\abovecaptionskip\setlength\abovecaptionskip{10\p@}
\newlength\belowcaptionskip\setlength\belowcaptionskip{10\p@}
\end{MacroCode}
    \begin{macro*}{\@makecaption}
    \changes{0.10c}{Fix missing coloring command for some captions}
\begin{MacroCode}{class}
\long\def\@makecaption#1#2{%
    \vskip\abovecaptionskip
    \sbox\@tempboxa{\small{\bfseries\@captionstyle#1:} \itshape#2}%
    \ifdim \wd\@tempboxa >\hsize
        \small{\bfseries\@captionstyle#1:} \itshape#2\par
    \else
        \global \@minipagefalse
        \hb@xt@\hsize{\hfil\box\@tempboxa\hfil}%
    \fi
    \vskip\belowcaptionskip}
\end{MacroCode}
    \end{macro*}

    \subsubsection{Table of contents}
\begin{MacroCode}{class}
\newcommand\@pnumwidth{1.55em}
\newcommand\@tocrmarg{2em}
\newcommand\@dotsep{1.7}
\setcounter{tocdepth}{5}
\end{MacroCode}
    \begin{macro}{\tableofcontents}
\begin{MacroCode}{class}
\newcommand\tableofcontents{%
  \section*{\contentsname
    \@mkboth{\MakeUppercase\contentsname}{\MakeUppercase\contentsname}
  }%
    \vskip\baselineskip%
  \@starttoc{toc}%
}
\end{MacroCode}
    \end{macro}
    \begin{macro*}{\l@section}
    \begin{macro*}{\l@subsection}
    \begin{macro*}{\l@subsubsection}
    \begin{macro*}{\l@paragraph}
    \begin{macro*}{\l@subparagraph}
\begin{MacroCode}{class}
\newcommand*\l@section{\@dottedtocline{1}{0em}{1.3em}}
\newcommand*\l@subsection{\@dottedtocline{2}{1.3em}{2em}}
\newcommand*\l@subsubsection{\@dottedtocline{3}{3.3em}{3.15em}}
\newcommand*\l@paragraph{\@dottedtocline{4}{6.45em}{4.15em}}
\newcommand*\l@subparagraph{\@dottedtocline{5}{10.6em}{5.15em}}
\end{MacroCode}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \end{macro*}
    \end{macro*}

    Fix for \emph{e.g.}~\pkg{tocloft} package.
\begin{MacroCode}{class}
\let\l@figure\@empty
\let\l@table\@empty
\end{MacroCode}

    \subsubsection{Basic bibliography support}
\begin{MacroCode}{class}
\newdimen\bibindent
\setlength\bibindent{2em}
\end{MacroCode}
    \begin{environment}{thebibliography}
\begin{MacroCode}{class}
\newenvironment{thebibliography}[1]
    {\section*{\refname}%
        \@mkboth{\MakeUppercase\refname}{\MakeUppercase\refname}%
        \list{\@biblabel{\@arabic\c@enumiv}}%
            {\settowidth\labelwidth{\@biblabel{#1}}%
                \leftmargin\labelwidth
                \advance\leftmargin\labelsep
                \@openbib@code
                \usecounter{enumiv}%
                \let\p@enumiv\@empty
                \renewcommand\theenumiv{\@arabic\c@enumiv}}%
        \sloppy
        \clubpenalty4000
        \@clubpenalty \clubpenalty
        \widowpenalty4000}%
    {\def\@noitemerr
        {\@latex@warning{Empty ‚Äòthebibliography‚Äô environment}}%
        \endlist}
\end{MacroCode}
    \end{environment}
    \begin{macro*}{\newblock}
\begin{MacroCode}{class}
\newcommand\newblock{\hskip .11em\@plus.33em\@minus.07em}
\end{MacroCode}
    \end{macro*}
\begin{MacroCode}{class}
\let\@openbib@code\@empty
\end{MacroCode}
    \begin{environment}{theindex}
\begin{MacroCode}{class}
\newenvironment{theindex}
    {\twocolumn[\section*{\indexname}]%
        \@mkboth{\MakeUppercase\indexname}%
            {\MakeUppercase\indexname}%
        \thispagestyle{plain}\parindent\z@
        \parskip\z@ \@plus .3\p@\relax
        \columnseprule \z@
        \columnsep 35\p@
        \let\item\@idxitem}
    {\onecolumn}
\end{MacroCode}
    \end{environment}
    \begin{macro*}{\@idxitem}
\begin{MacroCode}{class}
\newcommand\@idxitem{\par\hangindent 40\p@}
\end{MacroCode}
    \end{macro*}
    \begin{macro}{\subitem}
\begin{MacroCode}{class}
\newcommand\subitem{\@idxitem \hspace*{20\p@}}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\subsubitem}
\begin{MacroCode}{class}
\newcommand\subsubitem{\@idxitem \hspace*{30\p@}}
\end{MacroCode}
    \end{macro}
    \begin{macro*}{\indexspace}
\begin{MacroCode}{class}
\newcommand\indexspace{\par \vskip 10\p@ \@plus5\p@ \@minus3\p@\relax}
\end{MacroCode}
    \end{macro*}

    \subsubsection{Two-column mode}
    The twocolumn hacks implemented.
\begin{MacroCode}{class}
\ifskrapport@twocolumn
    \AtBeginDocument{
\end{MacroCode}
    We include the \pkg{grid} package in two-column mode, because
    it looks way better that way.
\begin{MacroCode}{class}
        \IfStrEq{\skrapport@paper}{a4paper}
            {\def\@@@lines{40}}{\def\@@@lines{28}}
        \IfStrEq{\skrapport@ptsize}{10pt}{
            \RequirePackage[fontsize=10pt,%
                            baseline=12pt,%
                            lines=\@@@lines]{grid}
        }{
            \IfStrEq{\skrapport@ptsize}{11pt}{
                \RequirePackage[fontsize=11pt,%
                                baseline=13.2pt,%
                                lines=\@@@lines]{grid}
            }{
                \RequirePackage[fontsize=12pt,%
                                baseline=14.4pt,%
                                lines=\@@@lines]{grid}
            }   
        }
\end{MacroCode}
    Now, we patch commands. First up is \env{abstract}.
\begin{MacroCode}{class}
        \renewenvironment{abstract}{\section*{\abstractname}}{}
\end{MacroCode}
    Then \env{document} and \cs{maketitle}.
\begin{MacroCode}{class}
        \AfterEndPreamble{\begin{multicols}{2}}
        \AtEndDocument{\end{multicols}}
        \pretocmd{\maketitle}{\end{multicols}}{}{}
        \apptocmd{\maketitle}{\begin{multicols}{2}}{}{}
\end{MacroCode}
    Always typeset \env{equation} and friends outside the grid:
\begin{MacroCode}{class}
        \BeforeBeginEnvironment{equation}{\begin{gridenv}}
        \AfterEndEnvironment{equation}{\end{gridenv}}
        \BeforeBeginEnvironment{equation*}{\begin{gridenv}}
        \AfterEndEnvironment{equation*}{\end{gridenv}}
        \BeforeBeginEnvironment{multline}{\begin{gridenv}}
        \AfterEndEnvironment{multline}{\end{gridenv}}
        \BeforeBeginEnvironment{multline*}{\begin{gridenv}}
        \AfterEndEnvironment{multline*}{\end{gridenv}}
        \BeforeBeginEnvironment{gather}{\begin{gridenv}}
        \AfterEndEnvironment{gather}{\end{gridenv}}
        \BeforeBeginEnvironment{gather*}{\begin{gridenv}}
        \AfterEndEnvironment{gather*}{\end{gridenv}}
        \BeforeBeginEnvironment{align}{\begin{gridenv}}
        \AfterEndEnvironment{align}{\end{gridenv}}
        \BeforeBeginEnvironment{align*}{\begin{gridenv}}
        \AfterEndEnvironment{align*}{\end{gridenv}}
        \BeforeBeginEnvironment{flalign}{\begin{gridenv}}
        \AfterEndEnvironment{flalign}{\end{gridenv}}
        \BeforeBeginEnvironment{flalign*}{\begin{gridenv}}
        \AfterEndEnvironment{flalign*}{\end{gridenv}}
        \BeforeBeginEnvironment{alignat}{\begin{gridenv}}
        \AfterEndEnvironment{alignat}{\end{gridenv}}
        \BeforeBeginEnvironment{alignat*}{\begin{gridenv}}
        \AfterEndEnvironment{alignat*}{\end{gridenv}}
\end{MacroCode}
    The \env{figure} environment is patched...
\begin{MacroCode}{class}
        \expandafter\let\expandafter
                    \old@figurest\csname figure*\endcsname
        \expandafter\let\expandafter
                    \old@endfigurest\csname endfigure*\endcsname
        \RenewDocumentEnvironment{figure}{o}{%
            \begin{gridenv}%
            \vspace{\intextsep}%
            \begin{minipage}{\linewidth}%
            \def\@captype{figure}%
        }{%
            \end{minipage}%
            \vspace{\intextsep}%
            \end{gridenv}%
        }
        \RenewDocumentEnvironment{figure*}{o}{\old@figurest}%
                                             {\old@endfigurest}
\end{MacroCode}
    ...as is \env{table}.
\begin{MacroCode}{class}
        \expandafter\let\expandafter
                    \old@tablest\csname table*\endcsname
        \expandafter\let\expandafter
                    \old@endtablest\csname endtable*\endcsname
        \RenewDocumentEnvironment{table}{o}{%
            \begin{gridenv}%
            \vspace{\intextsep}%
            \begin{minipage}{\linewidth}%
            \def\@captype{table}%
            \let\@old@caption\caption%
            \renewcommand{\caption}[1]{%
                \setlength{\@tempdima}{\abovecaptionskip}%
                \setlength{\abovecaptionskip}{\belowcaptionskip}%
                \setlength{\belowcaptionskip}{\@tempdima}%
                \@old@caption{##1}%
                \vspace{\belowcaptionskip}%
            }%
        }{%
            \end{minipage}%
            \vspace{\intextsep}%
            \end{gridenv}%
        }
        \let\oldoldtablest\oldtablest
        \renewcommand{\oldtablest}{%
            \oldoldtablest%
            \let\@old@caption\caption%
            \renewcommand{\caption}[1]{%
                \setlength{\@tempdima}{\abovecaptionskip}%
                \setlength{\abovecaptionskip}{\belowcaptionskip}%
                \setlength{\belowcaptionskip}{\@tempdima}%
                \@old@caption{##1}%
                \vspace{\belowcaptionskip}%
            }%
        }
        \RenewDocumentEnvironment{table*}{o}{\old@tablest}%
                                            {\old@endtablest}
\end{MacroCode}
    \begin{environment}{onecol}
    \changes{0.10}{Fixed, now not completely broken}
    Finally, we define an environment \env{onecol} that typesets
    arbitrary material in a single column. This is a bit tricky to
    do, and probably cargo-cult as well. We define the start of the
    environment to immediately end itself (with the empty ending),
    then end the \env{multiols} environment, redefine our end macro
    to start \env{multicols} as well as redefining the start of
    \env{onecol} to simply reset itself, then start the environment
    again only to have it ended at once.

    Basically, we trick \LaTeX\ into thinking that we have an empty
    \env{onecol} environment at the end of the first \env{multicols},
    then some content inside a fake \env{onecol}, then an empty
    \env{onecol} at the start of the next \env{multicols}. Voil√°, no
    wierd group errors!
\begin{MacroCode}{class}
        \newenvironment{onecol}{
            \end{onecol}
            \end{multicols}
            \begingroup
            \def\endonecol{
                \endgroup
                \begin{multicols}{2}
                \let\old@onecol\onecol
                \def\onecol{
                    \let\onecol\old@onecol
                }
                \begin{onecol}
            }
            \def\onecol{}
            \begin{onecol}
        }{}
    }
\end{MacroCode}
    \end{environment}
\begin{MacroCode}{class}
\fi
\end{MacroCode}

    \subsubsection{Miscellaneous}
    A macro \cs{comment} (alias \cs{com}/\cs{note}) is defined to let 
    the user add comments and notes to the document.
    \begin{macro}{\@comment}
\begin{MacroCode}{class}
\NewDocumentCommand\@comment{m}{%
    {\textbf{Comment:} #1}%
}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\comment}
    \changes{0.10}{Added macro for comments}
\begin{MacroCode}{class}
\NewDocumentCommand\comment{sm}{%
    \IfBooleanTF{#1}%
        {\colorbox{red!50}{\@comment{#2}}}%
        {\marginpar{\@comment{#2}}}%
}
\end{MacroCode}
    \end{macro}
    \begin{macro}{\com}
    \begin{macro}{\note}
    \changes{0.10b}{Fixed a silly error in \cs{com} and \cs{note}}
\begin{MacroCode}{class}
\ProvideDocumentCommand\com{sm}%
    {\IfBooleanTF{#1}{\comment*{#2}}{\comment{#2}}}
\ProvideDocumentCommand\note{sm}%
    {\IfBooleanTF{#1}{\comment*{#2}}{\comment{#2}}}
\end{MacroCode}
    \end{macro}
    \end{macro}

    \subsubsection{Color theme support}
    Color theme setup. Start by patching commands and declaring
    default colors. Not implemented: background colors for e.g.
    quote environments and sections headings, different colors
    for the different sectioning levels.
\begin{MacroCode}{class}
\ifskrapport@color
    \apptocmd{\bfseries}{\color{skrapport@boldcolor}}{}{\ClassError{skrapport}{Could not patch \protect\bfseries}{}}
    \apptocmd{\itshape}{\color{skrapport@italiccolor}}{}{\ClassError{skrapport}{Could not patch \protect\itshape}{}}
    \apptocmd{\@titstyle}{\color{skrapport@titlecolor}}{}{\ClassError{skrapport}{Could not patch \protect\@titstyle}{}}
    \def\@smallprintstyle{\color{skrapport@smallprintcolor}}
    \AtBeginDocument{%
        \let\@abstractname\abstractname
        \def\abstractname{\color{skrapport@titlecolor}\@abstractname}
    }
    \apptocmd{\quote}{\color{skrapport@quotecolor}}{}{}
    \def\@captionstyle{\color{skrapport@captioncolor}}
    \def\@emstyle{\color{skrapport@emphcolor}}
    \ifskrapport@twocolumn\AtBeginDocument{%
        \renewcommand\section{\@startsection {section}{1}{\z@}%
            {-.999\baselineskip}{0.001\baselineskip}{\bfseries\mathversion{bold}\color{skrapport@titlecolor}}}
        \renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
            {\baselineskip}{-.35\baselineskip}{\bfseries\color{skrapport@titlecolor}\unskip}}
        \renewcommand\subsubsection{\@startsection{subsubsection}{3}{\z@}%
            {\baselineskip}{-.35\baselineskip}{\itshape\color{skrapport@titlecolor}\unskip}}
    }\fi
    \renewcommand\paragraph{\@startsection{paragraph}{4}{\z@}%
        {1ex \@plus .25ex \@minus -.25ex}{-1em}{\normalfont\normalsize\bfseries\color{skrapport@titlecolor}}}
    \renewcommand\subparagraph{\@startsection{subparagraph}{5}{\parindent}%
        {1ex \@plus .25ex \@minus -.25ex}{-1em}{\normalfont\normalsize\itshape\color{skrapport@titlecolor}}}
    \AtBeginDocument{\@ifpackageloaded{hyperref}{%
        \hypersetup{%
            citebordercolor=skrapport@citecolor,citecolor=skrapport@citecolor,%
            filebordercolor=skrapport@filecolor,filecolor=skrapport@filecolor,%
            linkbordercolor=skrapport@linkcolor,linkcolor=skrapport@linkcolor,%
            menubordercolor=skrapport@menucolor,menucolor=skrapport@menucolor,%
            urlbordercolor=skrapport@urlcolor,urlcolor=skrapport@urlcolor,%
            runbordercolor=skrapport@runcolor,runcolor=skrapport@runcolor%
        }
    }{}}
    \AtBeginDocument{\color{skrapport@defaultcolor}}
\end{MacroCode}
    \begin{macro}{\colortheme}
    The \cs{colortheme} macro allows the end-user to load color themes
    (described later) to customize the colors of the document when the
    class is loaded with the \opt{color} option.
\begin{MacroCode}{class}
    \newcommand\colortheme[1]{\usepackage{skrapport-colortheme-#1}}
\end{MacroCode}
    \end{macro}
\begin{MacroCode}{class}
    \colortheme{default}
\fi
\end{MacroCode}

    \subsection{Final class setup}
    We end the document class by setting a few lengths along with the
    page style and page numbering. Also, activate \cs{raggedbottom} and
    \cs{onexolumn} (since we always do all the two-column stuff
    ourselves anyway).
\begin{MacroCode}{class}
\setlength\columnsep{10\p@}
\setlength\columnseprule{0\p@}
\pagestyle{plain}
\pagenumbering{arabic}
\raggedbottom
\onecolumn
\endinput
\end{MacroCode}

    \subsection{Color themes}
    As described earlier, the user can load color themes to customize
    the appearance of the document if the class was loaded with the
    \opt{color} option. Four themes are available by default.
    
    \subsubsection{Default color theme}
    \begin{theme}{Default}
    \changes{0.09}{Added default color theme}
\begin{MacroCode}{theme-default}
\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{skrapport-colortheme-default}%
    [2012/06/07 v1.0 skrapport color theme default]
\definecolor{skrapport@citecolor}{named}{green}
\definecolor{skrapport@filecolor}{named}{teal}
\definecolor{skrapport@linkcolor}{named}{red}
\definecolor{skrapport@menucolor}{named}{red}
\definecolor{skrapport@urlcolor}{named}{cyan}
\definecolor{skrapport@runcolor}{named}{teal}
\definecolor{skrapport@boldcolor}{named}{black}
\definecolor{skrapport@titlecolor}{named}{black}
\definecolor{skrapport@italiccolor}{named}{black}
\definecolor{skrapport@smallprintcolor}{named}{black}
\definecolor{skrapport@quotecolor}{named}{black}
\definecolor{skrapport@captioncolor}{named}{black}
\definecolor{skrapport@emphcolor}{named}{black}
\definecolor{skrapport@defaultcolor}{named}{black}
\endinput
\end{MacroCode}
    \end{theme}

    \subsubsection{Unscathed color theme}
    \begin{theme}{Unscathed}
    \changes{0.09}{Added ``Unschathed'' color theme}
\begin{MacroCode}{theme-unscathed}
\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{skrapport-colortheme-unscathed}%
    [2012/06/07 v1.0 skrapport color theme unscathed]
\definecolor{skrapport@citecolor}{named}{skrapport@defaultcolor}
\definecolor{skrapport@filecolor}{named}{skrapport@defaultcolor}
\definecolor{skrapport@menucolor}{named}{skrapport@defaultcolor}
\definecolor{skrapport@runcolor}{named}{skrapport@defaultcolor}
\definecolor{skrapport@emphcolor}{HTML}{463335}
\definecolor{skrapport@linkcolor}{HTML}{CF5D3B}
\definecolor{skrapport@urlcolor}{named}{skrapport@linkcolor}
\definecolor{skrapport@titlecolor}{HTML}{B34430}
\definecolor{skrapport@captioncolor}{named}{skrapport@titlecolor}
\definecolor{skrapport@quotecolor}{HTML}{70524A}
\definecolor{skrapport@smallprintcolor}{named}{skrapport@quotecolor}
\endinput
\end{MacroCode}
    \end{theme}

    \subsubsection{Cruelwater color theme}
    \begin{theme}{Cruelwater}
    \changes{0.09}{Added ``Cruelwater'' color theme}
\begin{MacroCode}{theme-cruelwater}
\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{skrapport-colortheme-cruelwater}%
    [2012/06/07 v1.0 skrapport color theme cruelwater]
\definecolor{skrapport@citecolor}{named}{black}
\definecolor{skrapport@filecolor}{named}{black}
\definecolor{skrapport@linkcolor}{named}{black}
\definecolor{skrapport@menucolor}{named}{black}
\definecolor{skrapport@urlcolor}{named}{black}
\definecolor{skrapport@runcolor}{named}{black}
\definecolor{skrapport@boldcolor}{HTML}{030C22}
\definecolor{skrapport@titlecolor}{HTML}{20293F}
\definecolor{skrapport@italiccolor}{named}{black}
\definecolor{skrapport@smallprintcolor}{HTML}{A9B0B3}
\definecolor{skrapport@quotecolor}{HTML}{404749}
\definecolor{skrapport@captioncolor}{HTML}{030C22}
\definecolor{skrapport@emphcolor}{HTML}{20293F}
\definecolor{skrapport@defaultcolor}{named}{black}
\endinput
\end{MacroCode}
    \end{theme}

    \subsubsection{Violet color theme}
    \begin{theme}{Violet}
\changes{0.09}{Added ``Violet'' color theme}
\begin{MacroCode}{theme-violet}
\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{skrapport-colortheme-violet}%
    [2012/06/07 v1.0 skrapport color theme violet]
\definecolor{skrapport@citecolor}{HTML}{932444}
\definecolor{skrapport@filecolor}{HTML}{932444}
\definecolor{skrapport@linkcolor}{HTML}{932444}
\definecolor{skrapport@menucolor}{HTML}{932444}
\definecolor{skrapport@urlcolor}{HTML}{932444}
\definecolor{skrapport@runcolor}{HTML}{932444}
\definecolor{skrapport@boldcolor}{HTML}{311A2A}
\definecolor{skrapport@titlecolor}{HTML}{311A2A}
\definecolor{skrapport@italiccolor}{named}{black}
\definecolor{skrapport@smallprintcolor}{HTML}{D6CBCF}
\definecolor{skrapport@quotecolor}{HTML}{463335}
\definecolor{skrapport@captioncolor}{HTML}{311A2A}
\definecolor{skrapport@emphcolor}{HTML}{98758D}
\definecolor{skrapport@defaultcolor}{named}{black}
\endinput
\end{MacroCode}
    \end{theme}

    \subsubsection{skdoc color theme}
    \begin{theme}{skdoc}
\changes{0.11a}{Added ``skdoc'' color theme}
\begin{MacroCode}{theme-skdoc}
\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{skrapport-colortheme-skdoc}%
    [2013/04/10 v1.0 skrapport color theme skdoc]
\definecolor{skrapport@citecolor}{RGB}{140,35,24}
\definecolor{skrapport@filecolor}{RGB}{73,10,61}
\definecolor{skrapport@linkcolor}{RGB}{140,35,24}
\definecolor{skrapport@menucolor}{RGB}{140,35,24}
\definecolor{skrapport@urlcolor}{RGB}{73,10,61}
\definecolor{skrapport@runcolor}{RGB}{73,10,61}
\definecolor{skrapport@boldcolor}{RGB}{73,10,61}
\definecolor{skrapport@titlecolor}{RGB}{11,72,107}
\definecolor{skrapport@italiccolor}{named}{black}
\definecolor{skrapport@smallprintcolor}{RGB}{11,72,107}
\definecolor{skrapport@quotecolor}{RGB}{140,35,24}
\definecolor{skrapport@captioncolor}{RGB}{11,72,107}
\definecolor{skrapport@emphcolor}{RGB}{73,10,61}
\definecolor{skrapport@defaultcolor}{named}{black}
\endinput
\end{MacroCode}
    \end{theme}

    \Finale
    \section{Installation}
    The easiest way to install this package is using the package
    manager provided by your \LaTeX\ installation if such a program
    is available. Failing that, provided you have obtained the package
    source (\file{skrapport.tex} and \file{Makefile}) from either CTAN
    or Github, running \texttt{make install} inside the source directory
    works well. This will extract the documentation and code from
    \file{skrapport.tex}, install all files into the TDS tree at
    \texttt{TEXMFHOME} and run \texttt{mktexlsr}.

    If you want to extract code and documentation without installing
    the package, run \texttt{make all} instead. If you insist on not
    using \texttt{make}, remember that packages distributed using
    \pkg{skdoc} must be extracted using \texttt{pdflatex}, \emph{not}
    \texttt{tex} or \texttt{latex}.

    \PrintChanges
    \PrintIndex
    \printbibliography
\end{document}
